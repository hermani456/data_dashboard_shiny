# global.R
library(shiny)
library(tidyverse)
library(bslib)
library(plotly)
library(scales)
library(caret)
library(lubridate)
library(janitor)


raw_data <- read_csv("data/superstore.csv", show_col_types = FALSE)


df_staging <- raw_data %>%
  clean_names() %>% # Convierte 'Order ID' a 'order_id', etc.
  mutate(
    # Surrogate Key (Clave única para el DW)
    transaccion_key = row_number(),
    
    # Limpieza de Fechas (El glimpse muestra formato DD/MM/YYYY)
    order_date = dmy(order_date),
    ship_date = dmy(ship_date),
    
    # Asegurar numéricos
    sales = as.numeric(sales),
    postal_code = as.character(postal_code) # El CP es mejor como texto
  ) %>%
  filter(!is.na(sales))

# --- 2. DATA WAREHOUSE (Modelo Estrella) ---

# DIM_CLIENTE
dim_cliente <- df_staging %>%
  distinct(customer_id, customer_name, segment) %>%
  mutate(cliente_key = row_number())

# DIM_UBICACION (Geografía)
dim_ubicacion <- df_staging %>%
  distinct(country, city, state, region, postal_code) %>%
  mutate(ubicacion_key = row_number())

# DIM_PRODUCTO (Jerarquía de producto)
dim_producto <- df_staging %>%
  distinct(product_id, category, sub_category, product_name) %>%
  mutate(producto_key = row_number())

# DIM_TIEMPO (Derivada de la fecha de orden)
dim_tiempo <- df_staging %>%
  select(order_date) %>%
  distinct() %>%
  mutate(
    anio = year(order_date),
    mes = month(order_date, label = TRUE, abbr = FALSE),
    dia_semana = wday(order_date, label = TRUE)
  ) %>%
  mutate(tiempo_key = row_number())

# HECHOS_VENTAS (Tabla Central)
fact_ventas <- df_staging %>%
  left_join(dim_cliente, by = c("customer_id", "customer_name", "segment")) %>%
  left_join(dim_ubicacion, by = c("country", "city", "state", "region", "postal_code")) %>%
  left_join(dim_producto, by = c("product_id", "category", "sub_category", "product_name")) %>%
  left_join(dim_tiempo, by = "order_date") %>%
  select(
    transaccion_key,
    cliente_key,
    ubicacion_key,
    producto_key,
    tiempo_key,
    sales,
    order_date # Se mantiene para gráficos de series de tiempo
  )

# DATA MART (Vista Desnormalizada para el Dashboard)
# Unimos todo para que Shiny pueda filtrar rápido
df_mart <- fact_ventas %>%
  left_join(dim_ubicacion, by = "ubicacion_key") %>%
  left_join(dim_producto, by = "producto_key") %>%
  left_join(dim_cliente, by = "cliente_key") %>%
  left_join(dim_tiempo, by = "tiempo_key")

# --- 3. MODELO DE REGRESIÓN (ML) ---
# Vamos a predecir las VENTAS basándonos en Categoría, Región y Segmento.
# Nota: R² suele ser bajo en retail sin 'cantidad', pero cumple el requisito académico.
set.seed(123)
modelo_lm <- lm(sales ~ category + region + segment, data = df_mart)

# Función para predecir (usada en server.R)
predecir_ventas <- function(cat, reg, seg) {
  nuevo_dato <- data.frame(
    category = cat,
    region = reg,
    segment = seg
  )
  pred <- predict(modelo_lm, newdata = nuevo_dato)
  return(max(0, pred)) # Evitar negativos
}